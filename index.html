<!DOCTYPE html>
<html>
<head>
  <title>GabMiel Website</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    section { margin-bottom: 30px; }
    input, textarea { width: 100%; margin: 5px 0; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>My Personal Chat Site</h1>

  <!-- Admin Topic Creation -->
  <section>
    <h2>Create Topic (Admin Only)</h2>
    <input id="topicTitle" placeholder="Topic Title" />
    <textarea id="topicDesc" placeholder="Topic Description"></textarea>
    <input id="adminPass" type="password" placeholder="Admin Password" />
    <button onclick="createTopic()">Create Topic</button>
  </section>

  <!-- Topic List -->
  <section>
    <h2>Available Topics</h2>
    <ul id="topicList"></ul>
  </section>

  <!-- Chat Box -->
  <section id="chatSection" style="display:none;">
    <h2>Chat in: <span id="chatTopicTitle"></span></h2>
    <input id="chatUsername" placeholder="Your Name" />
    <textarea id="chatMessage" placeholder="Your Message"></textarea>
    <button onclick="sendMessage()">Send Message</button>

    <h3>Messages</h3>
    <ul id="messageList"></ul>
  </section>

  <script>
    let currentTopicId = null;

    async function createTopic() {
      const title = document.getElementById('topicTitle').value;
      const description = document.getElementById('topicDesc').value;
      const password = document.getElementById('adminPass').value;

      const res = await fetch('/topics', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description, password })
      });

      if (res.ok) {
        alert('Topic created!');
        loadTopics();
      } else {
        alert('Failed to create topic');
      }
    }

    async function loadTopics() {
      const res = await fetch('/topics');
      const topics = await res.json();
      const list = document.getElementById('topicList');
      list.innerHTML = '';

      topics.forEach(topic => {
        const li = document.createElement('li');
        li.textContent = topic.title;
        li.style.cursor = 'pointer';
        li.onclick = () => openChat(topic.id, topic.title);
        list.appendChild(li);
      });
    }

    async function openChat(id, title) {
      currentTopicId = id;
      document.getElementById('chatTopicTitle').textContent = title;
      document.getElementById('chatSection').style.display = 'block';
      loadMessages();
    }

    async function sendMessage() {
      const username = document.getElementById('chatUsername').value;
      const message = document.getElementById('chatMessage').value;

      await fetch(`/topics/${currentTopicId}/messages`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, message })
      });

      document.getElementById('chatMessage').value = '';
      loadMessages();
    }

    async function loadMessages() {
      const res = await fetch(`/topics/${currentTopicId}/messages`);
      const msgs = await res.json();
      const list = document.getElementById('messageList');
      list.innerHTML = '';

      msgs.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = `${msg.username}: ${msg.message}`;
        list.appendChild(li);
      });
    }

    loadTopics();
  </script>
</body>
</html>